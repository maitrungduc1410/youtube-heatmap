<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Heatmap Renderer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background-color: #1a1a1a;
        color: #e0e0e0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        margin-bottom: 20px;
        color: #fff;
      }
      h2 {
        font-size: 16px;
        margin-bottom: 10px;
      }
      .input-section {
        margin-bottom: 30px;
      }
      textarea {
        width: 100%;
        height: 150px;
        background-color: #2a2a2a;
        color: #e0e0e0;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        resize: vertical;
      }
      button {
        margin-top: 10px;
        margin-right: 10px;
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }
      button:hover {
        background-color: #45a049;
      }
      button.secondary {
        background-color: #2196F3;
      }
      button.secondary:hover {
        background-color: #0b7dda;
      }
      .error {
        color: #ff6b6b;
        margin-top: 10px;
        padding: 10px;
        background-color: #2a1a1a;
        border-radius: 4px;
        display: none;
      }
      .heatmap-section {
        margin-bottom: 40px;
      }
      .heatmap-title {
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: bold;
      }
      .ytp-heat-map-container {
        height: 60px;
        background-color: #2a2a2a;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 20px;
      }
      .ytp-heat-map-chapter {
        width: 100%;
        height: 40px;
        position: relative;
      }
      .info {
        color: #aaa;
        margin: 10px 0;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>YouTube Heatmap Renderer</h1>
      
      <div class="input-section">
        <h2>Paste YouTube Data</h2>
        <div style="text-align: center;">
          <img src="usage.png" alt="YouTube Logo" width="50%" />
        </div>
        <p class="info">Paste the entire "var ytInitialData = {...}" code from any YouTube video page:</p>
        <textarea id="ytDataInput" placeholder="var ytInitialData = { ... }"></textarea>
        <button onclick="renderHeatmap()">Generate Heatmap</button>
        <button class="secondary" onclick="loadSampleData()">Load Sample Data</button>
        <div class="error" id="errorMessage"></div>
      </div>

      <div class="heatmap-section">
        <div class="heatmap-title">Smooth Version (Bezier Curves)</div>
        <div class="ytp-heat-map-container">
          <div class="ytp-heat-map-chapter" id="smoothHeatmap">
            <!-- Smooth heatmap will be rendered here -->
          </div>
        </div>
      </div>

      <div class="heatmap-section">
        <div class="heatmap-title">Non-Smooth Version (Lines)</div>
        <div class="ytp-heat-map-container">
          <div class="ytp-heat-map-chapter" id="lineHeatmap">
            <!-- Line heatmap will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <script src="logic.js"></script>
    <script>
      function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 5000);
      }

      async function loadSampleData() {
        try {
          const response = await fetch('sample-data.txt');
          if (!response.ok) {
            throw new Error('Failed to load sample data');
          }
          const data = await response.text();
          document.getElementById('ytDataInput').value = data;
          renderHeatmap();
        } catch (e) {
          showError('Error loading sample data: ' + e.message);
        }
      }

      function extractMarkersData(input) {
        try {
          // Remove "var ytInitialData =" if present
          let jsonStr = input.trim();
          if (jsonStr.startsWith('var ytInitialData')) {
            jsonStr = jsonStr.replace(/^var\s+ytInitialData\s*=\s*/, '');
          }
          
          // Remove trailing semicolon if present
          jsonStr = jsonStr.replace(/;\s*$/, '');
          // Parse the JSON
          const data = JSON.parse(jsonStr);
          
          // Navigate to markersList
          const mutations = data?.frameworkUpdates?.entityBatchUpdate?.mutations;
          if (mutations && Array.isArray(mutations)) {
            for (let mutation of mutations) {
              if (mutation?.payload?.macroMarkersListEntity?.markersList?.markerType === 'MARKER_TYPE_HEATMAP') {
                return mutation?.payload?.macroMarkersListEntity?.markersList;
              }
            }
          }
          
          throw new Error('Heatmap data not found in the provided data');
        } catch (e) {
          throw new Error('Failed to parse data: ' + e.message);
        }
      }

      function createSVG(pathD, gradientId) {
        return `
          <svg
            class="ytp-heat-map-svg"
            height="100%"
            preserveAspectRatio="none"
            version="1.1"
            viewBox="0 0 1000 100"
            width="100%"
            style="height: 40px"
          >
            <defs>
              <linearGradient
                id="${gradientId}"
                x1="0%"
                x2="0%"
                y1="0%"
                y2="100%"
              >
                <stop offset="0%" stop-color="white" stop-opacity="1"></stop>
                <stop offset="100%" stop-color="white" stop-opacity="0"></stop>
              </linearGradient>
            </defs>
            <path
              class="ytp-modern-heat-map"
              d="${pathD}"
              fill="url(#${gradientId})"
              height="100%"
              stroke="white"
              stroke-opacity="1"
              stroke-width="2px"
              width="100%"
              x="0"
              y="0"
            ></path>
          </svg>
        `;
      }

      function renderHeatmap() {
        const input = document.getElementById('ytDataInput').value;
        
        if (!input.trim()) {
          showError('Please paste YouTube data first');
          return;
        }

        try {
          const markersData = extractMarkersData(input);
          
          if (!markersData || !markersData.markers || markersData.markers.length === 0) {
            showError('No heatmap markers found in the data');
            return;
          }

          // Get metadata
          const minHeightDp = markersData.markersMetadata?.heatmapMetadata?.minHeightDp ?? 0;
          const maxHeightDp = markersData.markersMetadata?.heatmapMetadata?.maxHeightDp ?? 60;
          const baseHeight = 40;
          const useSmooth = true;

          // Filter markers
          const filteredMarkers = [];
          const startTime = 0;
          const endTime = Infinity;
          
          for (const marker of markersData.markers) {
            const startMillis = Number(marker.startMillis);
            if (startMillis >= startTime && startMillis <= endTime) {
              filteredMarkers.push(marker);
            }
          }

          // Generate point data
          const pointData = YGX(filteredMarkers, minHeightDp, baseHeight, maxHeightDp, useSmooth);
          
          // Generate smooth path (Bezier curves)
          const smoothPath = EAK(pointData, true);
          document.getElementById('smoothHeatmap').innerHTML = createSVG(smoothPath, 'gradient-smooth');
          
          // Generate line path
          const linePath = EAK(pointData, false);
          document.getElementById('lineHeatmap').innerHTML = createSVG(linePath, 'gradient-line');
          
        } catch (e) {
          showError(e.message);
        }
      }
    </script>
  </body>
</html>
